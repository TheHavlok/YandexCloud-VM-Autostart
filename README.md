# Yandex Cloud Preemptible VM Auto-Start Monitor

–°–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –∑–∞–ø—É—Å–∫–∞ **–ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã—Ö (Preemptible) –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω** –≤ **Yandex Cloud**.

–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –∫–æ–≥–¥–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞:
- —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞–∫ *–ø—Ä–µ—Ä—ã–≤–∞–µ–º–∞—è* (–¥–µ—à–µ–≤–ª–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π VM),
- –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ Yandex Cloud –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç,
- –¥–æ–ª–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–Ω–∏–º–∞—Ç—å—Å—è –æ–±—Ä–∞—Ç–Ω–æ –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ –∫–∞–∫ `systemd`-—Å–ª—É–∂–±–∞ –Ω–∞ Linux (Debian / Ubuntu).

---

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å VM –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –µ—ë, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.
- **Support OAuth**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OAuth —Ç–æ–∫–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IAM —Ç–æ–∫–µ–Ω–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ—á–Ω–æ, –Ω–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤).
- **JSON Config**: –£–¥–æ–±–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `~/.config/yandex-autostart/config.json`.
- **Systemd Service**: –ì–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å–ª—É–∂–±—ã –¥–ª—è –ª–µ–≥–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏.
- **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**: –ú–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –æ–±–ª–∞–∫–æ, –ø–∞–ø–∫—É –∏ VM.

---

## üõ† –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Linux (Debian / Ubuntu / CentOS)
- Python 3.6+
- –ú–æ–¥—É–ª—å `requests`

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
sudo apt update
sudo apt install -y python3 python3-pip
pip3 install requests
```

–ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ `/opt` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –º–µ—Å—Ç–æ):
```bash
cd /opt
sudo git clone https://github.com/TheHavlok/YandexCloud-VM-Autostart.git yandex-vm-autostart
cd yandex-vm-autostart
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
```bash
python3 main.py --setup
```
–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ:
1. –í–≤–µ–¥–∏—Ç–µ [OAuth —Ç–æ–∫–µ–Ω](https://yandex.cloud/ru/docs/iam/concepts/authorization/oauth-token).
2. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é VM –∏–∑ —Å–ø–∏—Å–∫–∞.
3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `~/.config/yandex-autostart/config.json`.

> **–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ –≤—ã –±—É–¥–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–ª—É–∂–±—É –æ—Ç –∏–º–µ–Ω–∏ `root`, –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É —á–µ—Ä–µ–∑ `sudo python3 main.py --setup`, —á—Ç–æ–±—ã –∫–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ `/root/.config/...`.

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Systemd —Å–ª—É–∂–±—ã
–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª `yandex-autostart.service`.

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª —Å–ª—É–∂–±—ã:
   ```bash
   sudo cp yandex-autostart.service /etc/systemd/system/
   ```

2. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø—É—Ç—å, –µ—Å–ª–∏ –≤—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ **–Ω–µ** –≤ `/opt/yandex-vm-autostart`:
   ```bash
   sudo nano /etc/systemd/system/yandex-autostart.service
   ```
   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä `ExecStart`.

3. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª—É–∂–±—É:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable yandex-autostart
   sudo systemctl start yandex-autostart
   ```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:
   ```bash
   sudo systemctl status yandex-autostart
   ```

---

## üñ• –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
–õ–æ–≥–∏ —Å–ª—É–∂–±—ã –ø–∏—à—É—Ç—Å—è –≤ journald:
```bash
journalctl -u yandex-autostart -f
```

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
```bash
python3 main.py
```
–ò–ª–∏ PowerShell –≤–µ—Ä—Å–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ):
```powershell
pwsh main.ps1
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–§–∞–π–ª: `~/.config/yandex-autostart/config.json`

```json
{
  "oauth_token": "y3_YourOAuthToken...",
  "instance_id": "epd...",
  "instance_name": "my-vm",
  "check_interval": 60
}
```
- `check_interval`: –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö.